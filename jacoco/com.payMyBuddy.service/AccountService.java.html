<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AccountService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">demo</a> &gt; <a href="index.source.html" class="el_package">com.payMyBuddy.service</a> &gt; <span class="el_source">AccountService.java</span></div><h1>AccountService.java</h1><pre class="source lang-java linenums">package com.payMyBuddy.service;

import com.payMyBuddy.dto.account.AccountCreateDTO;
import com.payMyBuddy.dto.account.AccountResponseDTO;
import com.payMyBuddy.dto.account.BalanceUpdateDTO;
import com.payMyBuddy.dto.account.ReceiversAccountsResponseDTO;
import com.payMyBuddy.dto.user.ContactResponseDTO;
import com.payMyBuddy.dto.user.UserResponseDTO;
import com.payMyBuddy.exception.ConflictException;
import com.payMyBuddy.exception.ResourceNotFoundException;
import com.payMyBuddy.mapper.AccountMapper;
import com.payMyBuddy.model.Account;
import com.payMyBuddy.model.User;
import com.payMyBuddy.repository.AccountRepository;
import jakarta.transaction.Transactional;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.math.BigDecimal;
import java.time.Instant;
import java.util.ArrayList;
import java.util.List;
import java.util.Set;

/**
 * The type Account service.
 */
@Service
@Transactional
@RequiredArgsConstructor
public class AccountService {

    private final AccountRepository accountRepository;
    private final AccountMapper accountMapper;

    private final UserService userService;

    /**
     * Find account by id - internal use.
     *
     * @param accountId the account id
     * @return the account
     */
    public Account findAccountByIdInternalUse(Integer accountId) {
<span class="fc" id="L45">        return accountRepository.findById(accountId)</span>
<span class="fc" id="L46">            .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Compte non trouvé.&quot;));</span>
    }

    /**
     * Create account.
     *
     * @param accountCreateDTO the account create dto
     * @param userId           the user id
     */
    public void createAccount(AccountCreateDTO accountCreateDTO, Integer userId) {

<span class="fc" id="L57">        User user = userService.findByUserIdInternalUse(userId);</span>

<span class="fc bfc" id="L59" title="All 2 branches covered.">        if (accountRepository.existsByNameAndUser_Id(accountCreateDTO.getName(), userId)) {</span>
<span class="fc" id="L60">            throw new ConflictException(&quot;Vous avez déjà un compte avec ce nom. Veuillez en choisir un autre.&quot;);</span>
        }

<span class="fc" id="L63">        Account account = accountMapper.toEntityFromCreateDTO(accountCreateDTO);</span>
<span class="fc" id="L64">        account.setUser(user);</span>
<span class="fc" id="L65">        account.setBalance(BigDecimal.ZERO);</span>
<span class="fc" id="L66">        account.setCreatedAt(Instant.now());</span>

<span class="fc" id="L68">        accountRepository.save(account);</span>
<span class="fc" id="L69">    }</span>

    /**
     * Delete account.
     *
     * @param accountId the account id
     */
    public void deleteAccount(Integer accountId) {

<span class="fc" id="L78">        Account account = findAccountByIdInternalUse(accountId);</span>
<span class="fc" id="L79">        accountRepository.delete(account);</span>
<span class="fc" id="L80">    }</span>

    /**
     * Update balance account.
     *
     * @param balanceUpdateDTO the balance update dto
     */
    public void updateBalanceAccount(BalanceUpdateDTO balanceUpdateDTO) {

<span class="fc" id="L89">        Account account = findAccountByIdInternalUse(balanceUpdateDTO.getAccountId());</span>
<span class="fc" id="L90">        account.setBalance(</span>
<span class="fc" id="L91">            account.getBalance()</span>
<span class="fc" id="L92">                .add(balanceUpdateDTO.getAmount())</span>
        );

<span class="fc" id="L95">        accountRepository.save(account);</span>
<span class="fc" id="L96">    }</span>

    /**
     * Find accounts for current user and his contacts list.
     *
     * @param userId the user id
     * @return the list
     */
    public List&lt;ReceiversAccountsResponseDTO&gt; findAccountsForCurrentUserAndHisContacts(Integer userId) {

<span class="fc" id="L106">        List&lt;ReceiversAccountsResponseDTO&gt; allAccountsDTO = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L108">        UserResponseDTO currentUser = userService.findByUserId(userId);</span>
<span class="fc" id="L109">        List&lt;AccountResponseDTO&gt; selfAccounts =</span>
<span class="fc" id="L110">            accountRepository.findByUserId(userId).stream()</span>
<span class="fc" id="L111">                .map(accountMapper::toAccountResponseDTO)</span>
<span class="fc" id="L112">                .toList();</span>

<span class="fc" id="L114">        allAccountsDTO.add(</span>
            new ReceiversAccountsResponseDTO(
<span class="fc" id="L116">                currentUser.getUsername(),</span>
                selfAccounts
        ));

<span class="fc" id="L120">        Set&lt;ContactResponseDTO&gt; contacts = currentUser.getContacts();</span>

<span class="fc" id="L122">        allAccountsDTO.addAll(</span>
<span class="fc" id="L123">            contacts.stream()</span>
<span class="fc" id="L124">                .map(contact -&gt; {</span>

<span class="fc" id="L126">                    Set&lt;Account&gt; accounts = accountRepository.findByUserId(contact.getContactId());</span>
<span class="fc" id="L127">                    List&lt;AccountResponseDTO&gt; beneficiaryAccounts = accounts.stream()</span>
<span class="fc" id="L128">                        .map(accountMapper::toAccountResponseDTO)</span>
<span class="fc" id="L129">                        .toList();</span>

<span class="fc" id="L131">                    return new ReceiversAccountsResponseDTO(</span>
<span class="fc" id="L132">                        contact.getUsername(),</span>
                        beneficiaryAccounts
                    );

<span class="fc" id="L136">                }).toList()</span>
        );

<span class="fc" id="L139">        return allAccountsDTO;</span>
    }

    /**
     * Save account.
     *
     * @param account the account
     */
    public void saveAccount(Account account) {
<span class="fc" id="L148">        accountRepository.save(account);</span>
<span class="fc" id="L149">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>